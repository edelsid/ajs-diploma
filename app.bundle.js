(()=>{"use strict";class e{constructor(){this.turn=!0,this.maxLevel=4,this.lvl=1,this.score=0}}class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.gameState=new e,this.enemyTypes=["vampire","undead","daemon"]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t===a-1?"top-right":(t+1)/a===a?"bottom-right":(t+a)/a===a?"bottom-left":t<a?"top":t%a==0?"left":(t+1)%a==0?"right":t/a>=a-1&&t/a<=a?"bottom":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${a.character.health}%`,i.appendChild(l),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(this,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(this,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(this,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}tooltipFormation(e){let t="";return this.gameState.allPositions.forEach((a=>{a.position===e&&(t=`üéñ${a.character.level} ‚öî${a.character.attack} üõ°${a.character.defence} ‚ù§${a.character.health}`)})),t}onCharSelected(e){this.setCursor("pointer");const t=this.cells[e];return this.gameState.chosenChar.attackDist.includes(t)&&null!==t.firstChild&&this.enemyTypes.includes(t.firstChild.classList[1])?(this.setCursor("crosshair"),t.classList.add("selected","selected-red"),!1):null!==t.firstChild&&this.enemyTypes.includes(t.firstChild.classList[1])?(this.setCursor("not-allowed"),!1):(this.gameState.chosenChar.movementDist.includes(t)&&(this.setCursor("pointer"),t.classList.add("selected","selected-green")),!1)}getMovement(e,t,a){let s=[];return"magician"===a.character.type||"daemon"===a.character.type?s=this.calcCells(e,t,s,1):"bowman"===a.character.type||"vampire"===a.character.type?s=this.movementCycle(e,t,s,2):"swordsman"!==a.character.type&&"undead"!==a.character.type||(s=this.movementCycle(e,t,s,4)),s}getAttack(e,t,a){let s=[];return"swordsman"===a.character.type||"undead"===a.character.type?s=this.calcCells(e,t,s,1):"bowman"===a.character.type||"vampire"===a.character.type?s=this.atkCycle(e,t,s,2):"magician"!==a.character.type&&"daemon"!==a.character.type||(s=this.atkCycle(e,t,s,4)),s}movementCycle(e,t,a,s){for(let i=1;i<=s;i+=1)a=this.calcCells(e,t,a,i);return a}atkCycle(e,t,a,s){for(let i=Math.max(0,e-s);i<=e+s;i+=1)for(let e=Math.max(0,t-s);e<=t+s;e+=1)i<=7&&e<=7&&void 0!==this.board[i][e]&&a.push(this.board[i][e]);return a}calcCells(e,t,a,s){return t-s>=0&&void 0!==this.board[e][t-s]&&a.push(this.board[e][t-s]),t+s<=7&&void 0!==this.board[e][t+s]&&a.push(this.board[e][t+s]),e+s<=7&&void 0!==this.board[e+s][t]&&a.push(this.board[e+s][t]),e-s>=0&&void 0!==this.board[e-s][t]&&a.push(this.board[e-s][t]),t+s<=7&&e+s<=7&&void 0!==this.board[e+s][t+s]&&a.push(this.board[e+s][t+s]),e-s>=0&&t-s>=0&&void 0!==this.board[e-s][t-s]&&a.push(this.board[e-s][t-s]),e+s<=7&&t-s>=0&&void 0!==this.board[e+s][t-s]&&a.push(this.board[e+s][t-s]),t+s<=7&&e-s>=0&&void 0!==this.board[e-s][t+s]&&a.push(this.board[e-s][t+s]),a}calcCoordinates(e){let t;for(let a=0;a<this.board.length;a+=1)for(let s=0;s<this.board[0].length;s+=1)this.board[s][a]===this.cells[e]&&(t=[s,a]);return t}calculateArea(e){const t=this.gameState.chosenChar,a=this.calcCoordinates(e);t.movementDist=this.getMovement(a[0],a[1],t),t.attackDist=this.getAttack(a[0],a[1],t,e)}paintAreas(){this.gameState.chosenChar.movementDist.forEach((e=>{e.classList.add("selected","selected-movement")})),this.gameState.chosenChar.attackDist.forEach((e=>{e.classList.add("selected","selected-attack")}))}moveChar(e){return this.gameState.chosenChar.movementDist.includes(this.cells[e])?(this.gameState.chosenChar.position=e,this.redrawPositions(this.gameState.allPositions),!0):(this.constructor.showError("–ù–∞ —ç—Ç—É –∫–ª–µ—Ç–∫—É –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–≤–∏–Ω—É—Ç—å—Å—è"),!1)}atkChar(e){const t=this.gameState.chosenChar.character;let a;for(const t of this.gameState.allPositions)t.position===e&&(a=t);const s=Math.max(t.attack-a.character.defence,.1*t.attack),i=parseFloat(s.toFixed(1));return new Promise(((t,s)=>{this.gameState.chosenChar.attackDist.includes(this.cells[e])?this.showDamage(e,i).then((()=>{a.character.health-=i,a.character.health<=0&&this.charDeath(a),this.redrawPositions(this.gameState.allPositions),t()})):s()}))}charDeath(e){const t=this.gameState.allPositions.findIndex((t=>t===e));if(this.gameState.turn){const a=this.gameState.enemyTeam.findIndex((t=>t===e));this.gameState.enemyTeam.splice(a,1),this.gameState.allPositions.splice(t,1),this.gameState.score+=1}else if(!1===this.gameState.turn){const a=this.gameState.playerTeam.findIndex((t=>t===e));this.gameState.playerTeam.splice(a,1),this.gameState.allPositions.splice(t,1)}}cleanTurn(){this.gameState.charChosen=!1,delete this.gameState.chosenChar.attackDist,delete this.gameState.chosenChar.movementDist,this.gameState.chosenChar={},this.gameState.enemyTarget={},this.board.forEach((e=>{e.forEach((e=>{e.classList.remove("selected","selected-movement","selected-attack","selected-yellow","selected-green","selected-red")}))}))}updateTeams(){this.gameState.playerTeam=[],this.gameState.enemyTeam=[],this.gameState.allPositions.forEach((e=>{this.enemyTypes.includes(e.character.type)?this.gameState.enemyTeam.push(e):this.gameState.playerTeam.push(e)}))}changeTurn(){return this.cleanTurn(),this.gameState.turn?(this.gameState.turn=!this.gameState.turn,alert("–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞"),this.enemyTurn(),!1):(!1===this.gameState.turn&&(this.gameState.turn=!this.gameState.turn,alert("–•–æ–¥ –∏–≥—Ä–æ–∫–∞")),!0)}playerTurn(e){let t;return["bowman","swordsman","magician"].forEach((a=>{e.character.type===a&&(t=!0,this.gameState.charChosen=!0,this.gameState.chosenChar=e)})),t}enemyTurn(){this.gameState.enemyTeam&&(this.gameState.chosenChar=this.gameState.enemyTeam.reduce(((e,t)=>e&&e.character.attack>t.character.attack?e:t)))}static levelUp(e){const t=Math.max(e.attack,e.attack*((80+e.health)/100));e.attack=parseFloat(t.toFixed(1)),e.health+=80,e.health>100&&(e.health=100)}}const a={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class s{constructor(e,t="generic"){if(this.attack=0,this.defence=0,this.health=50,this.level=e,"Character"===new.target.name)throw new Error("–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞")}}const i=[class extends s{constructor(e){super(e),this.attack=25,this.defence=25,this.type="bowman"}},class extends s{constructor(e){super(e),this.attack=40,this.defence=10,this.type="swordsman"}},class extends s{constructor(e){super(e),this.attack=10,this.defence=40,this.type="magician"}}],l=[class extends s{constructor(e){super(e),this.attack=10,this.defence=10,this.type="daemon"}},class extends s{constructor(e){super(e),this.attack=40,this.defence=10,this.type="undead"}},class extends s{constructor(e){super(e),this.attack=25,this.defence=25,this.type="vampire"}}];function r(e,a,s){const i=function*(e,a){for(;;){const s=Math.floor(Math.random()*(a-1)+1),i=new(e[Math.floor(Math.random()*e.length)])(s);for(let e=1;e<s;e+=1)t.levelUp(i);yield i}}(e,a),l=[];for(let e=0;e<s;e+=1){const e=i.next().value;l.push(e)}return l}class n{constructor(e){this.characters=e}}class h{constructor(e,t){if(!(e instanceof s))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class o{constructor(e,t){this.gamePlay=e,this.stateService=t,this.onCellClick=this.onCellClick.bind(this)}static teamFormation(e,t){const a=[];for(let s=0;s<e.characters.length;s+=1){const i=t[Math.floor(Math.random()*t.length)];t.splice(t.indexOf(i),1);const l=new h(e.characters[s],i);a.push(l)}return a}init(e,t){if(0!==localStorage.length&&void 0===e&&void 0===t)this.onLoadGame(),this.events();else{void 0===e&&(e=1);const{gameState:s}=this.gamePlay;this.gamePlay.drawUi(a[e]);const h=new n(r(i,s.maxLevel,2)),c=new n(r(l,s.maxLevel,2));this.gamePlay.board=this.board();const m=[],d=[];this.gamePlay.board.forEach((e=>{m.push(this.gamePlay.cells.indexOf(e[0]),this.gamePlay.cells.indexOf(e[1])),d.push(this.gamePlay.cells.indexOf(e[6]),this.gamePlay.cells.indexOf(e[7]))})),s.playerTeam=o.teamFormation(h,m),s.enemyTeam=o.teamFormation(c,d),t&&(s.playerTeam=t),s.allPositions=[...s.playerTeam,...s.enemyTeam],this.gamePlay.redrawPositions(s.allPositions),this.events()}}board(){const e=Array.from(this.gamePlay.cells),t=[];for(let a=1;a<9;a+=1){const a=e.splice(0,8);t.push(a)}return t}events(){this.onNewGame=this.onNewGame.bind(this),this.onSaveGame=this.onSaveGame.bind(this),this.onLoadGame=this.onLoadGame.bind(this),this.gamePlay.addNewGameListener(this.onNewGame),this.gamePlay.addSaveGameListener(this.onSaveGame),this.gamePlay.addLoadGameListener(this.onLoadGame),this.gamePlay.addCellEnterListener(this.onCellEnter),this.gamePlay.addCellLeaveListener(this.onCellLeave),this.gamePlay.addCellClickListener(this.onCellClick)}onCellClick(e){let t;const a=this.gamePlay.gameState,s=this.gamePlay.cells[e];if(null!==s.firstChild&&a.turn){let s;for(const t of a.allPositions)t.position===e&&(s=t);t=this.gamePlay.playerTurn(s)}if(t)this.gamePlay.selectCell(e),this.gamePlay.calculateArea(e),this.gamePlay.paintAreas();else if(a.charChosen&&null===s.firstChild)this.gamePlay.moveChar(e)&&(this.gamePlay.updateTeams(),this.enemyPhase());else if(a.charChosen&&null!==s.firstChild&&["vampire","daemon","undead"].includes(s.firstChild.classList[1])){let t=!1;this.gamePlay.atkChar(e).then((()=>{this.victoryCheck()&&(this.gamePlay.cleanTurn(),a.turn=!0,t=!0),!1===t&&(this.gamePlay.updateTeams(),this.enemyPhase())}),(()=>{this.gamePlay.constructor.showError("–ù–∞ —ç—Ç–æ–π –∫–ª–µ—Ç–∫–µ –Ω–µ–ª—å–∑—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞—Ç–∞–∫—É")}))}else this.gamePlay.constructor.showError("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã")}onCellEnter(e){null!==this.cells[e].firstChild&&this.showCellTooltip(this.tooltipFormation(e),e),this.gameState.charChosen&&this.onCharSelected(e)}onCellLeave(e){this.hideCellTooltip(e),this.gameState.charChosen&&(this.cells[e].classList.remove("selected-green","selected-red"),this.setCursor("auto"))}enemyPhase(){const e=this.gamePlay.gameState;this.gamePlay.setCursor("auto"),this.gamePlay.changeTurn();const t=e.chosenChar;this.gamePlay.calculateArea(t.position),e.enemyTarget=e.playerTeam.reduce(((e,t)=>e&&e.character.defence<t.character.defence?e:t));const a=[];t.attackDist.forEach((e=>{a.push(this.gamePlay.cells.indexOf(e))})),a.includes(e.enemyTarget.position)?this.enemyAtk():this.enemyMovement(t)}enemyMovement(e){const t=this.gamePlay.gameState,a=[];t.allPositions.forEach((e=>{const t=this.gamePlay.calcCoordinates(e.position);a.push(JSON.stringify(t))}));const s=this.gamePlay.calcCoordinates(t.enemyTarget.position),i={};let l,r;for(let t=0;t<e.movementDist.length;t+=1){const a=this.gamePlay.cells.indexOf(e.movementDist[t]);i[t]=this.gamePlay.calcCoordinates(a)}for(const e of Object.values(i)){const t=o.distance(s,e);(void 0===l||t<l)&&!a.includes(JSON.stringify(e))&&(r=this.gamePlay.board[e[0]][e[1]],l=t)}o.delay(1e3).then((()=>{this.gamePlay.moveChar(this.gamePlay.cells.indexOf(r)),this.gamePlay.changeTurn()}))}static distance(e,t){const a=e[0]-t[0],s=e[1]-t[1];return a*a+s*s}enemyAtk(){o.delay(1e3).then((()=>{this.gamePlay.atkChar(this.gamePlay.gameState.enemyTarget.position).then((()=>{this.lossCheck()||this.gamePlay.changeTurn()}))}))}static delay(e){return new Promise((t=>{setTimeout(t,e)}))}victoryCheck(){return 0===Object.keys(this.gamePlay.gameState.enemyTeam).length&&(alert("–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!"),this.gamePlay.gameState.playerTeam.forEach((e=>{e.character.level<this.gamePlay.gameState.maxLevel&&(t.levelUp(e.character),e.character.level+=1)})),this.gamePlay.gameState.lvl<4?(this.gamePlay.gameState.lvl+=1,this.removeBoardEvents(),this.removeControlEvents(),this.init(this.gamePlay.gameState.lvl,this.gamePlay.gameState.playerTeam),!0):(alert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–æ—à–ª–∏ –∏–≥—Ä—É!"),this.removeBoardEvents(),!0))}lossCheck(){return 0===Object.keys(this.gamePlay.gameState.playerTeam).length&&(alert("–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!"),this.removeBoardEvents(),!0)}removeBoardEvents(){this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[]}removeControlEvents(){this.gamePlay.newGameListeners=[],this.gamePlay.saveGameListeners=[],this.gamePlay.loadGameListeners=[]}onNewGame(){this.removeBoardEvents(),this.removeControlEvents(),this.gamePlay.gameState.lvl=1,this.init(this.gamePlay.gameState.lvl)}onSaveGame(){this.stateService.save(this.gamePlay.gameState)}onLoadGame(){let e;try{e=this.stateService.load()}catch(e){this.gamePlay.constructor.showError(e)}null!==e&&(this.gamePlay.gameState=e,this.gamePlay.drawUi(a[this.gamePlay.gameState.lvl]),this.gamePlay.redrawPositions(this.gamePlay.gameState.allPositions),this.gamePlay.board=this.board())}}const c=new t;c.bindToDOM(document.querySelector("#game-container"));const m=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new o(c,m).init()})();